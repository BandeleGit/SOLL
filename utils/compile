#!/bin/bash

LLOPT=$(command -v opt-8)
LLOPT=${LLOPT:-$(command -v opt)}
LLC=$(command -v llc-8)
LLC=${LLC:-$(command -v llc)}
WASM_LD=$(command -v wasm-ld-8)
WASM_LD=${WASM_LD:-$(command -v wasm-ld)}
WASM_OPT=$(command -v wasm-opt)

VERBOSE=false

while getopts 'vho:' OPT; do
    case $OPT in
        v)
            VERBOSE=true
            ;;
        h|?)
            echo "Usage: $0 [-v] INPUT"
            exit 1
            ;;
    esac
done

shift $(("$OPTIND" - 1))

run() {
    if "$VERBOSE"; then
        for arg in "$@"; do
            echo -n \""$arg"\"' '
        done
        echo
    fi
    "$@"
}

for INPUT in "$@"; do
    run "$LLOPT" -Oz "$INPUT" -o "${INPUT%.ll}.bc" && \
    run "$LLC" -O3 -filetype=obj "${INPUT%.ll}.bc" && \
    run "$WASM_LD" --entry main --gc-sections --allow-undefined "${INPUT%.ll}.o" -o "${INPUT%.ll}.wasm" && \
    [ "$WASM_OPT" ] && run "$WASM_OPT" -O4 "${INPUT%.ll}.wasm" -o "${INPUT%.ll}-opt.wasm"
done
